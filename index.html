<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>LD46</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.19.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>
<script type="text/javascript">
var config = {
    type: Phaser.AUTO,
    width: 800,
    height: 600,
    physics: {
        default: 'arcade',
        arcade: {
            gravity: { y: 0 },
            debug: false
        }
    },
    scene: {
        preload: preload,
        create: create,
        update: update
    }
};

var player;
var cursors;
var firing = false;
var lock_position = false;
var lock_key = false;

var game = new Phaser.Game(config);

function preload() {
   load_player(this);
}

function create() {
    cursors = this.input.keyboard.createCursorKeys();

    create_player(this);
}

function update() {
    update_player(this);
}

function load_player(game) {
    game.load.spritesheet('psu', 'assets/power_supply_unit_ld46.png', { frameWidth: 32, frameHeight: 32 });
    game.load.spritesheet('low', 'assets/low_volt.png', { frameWidth: 16, frameHeight: 16 });
}

function create_player(game) {
    player = game.physics.add.sprite(100, 450, 'psu');
    player.setCollideWorldBounds(true);
    player.speed = 200;
    player.firingSpeed = 500;

    player_projectiles = game.physics.add.group();

    game.anims.create({
       key:'left',
       frames: [{key: 'psu', frame: 3}],
       repeat: -1
    });

    game.anims.create({
       key:'right',
       frames: [{key: 'psu', frame: 2}],
       repeat: -1
    });

    game.anims.create({
       key:'up',
       frames: [{key: 'psu', frame: 0}],
       repeat: -1
    });

    game.anims.create({
       key:'down',
       frames: [{key: 'psu', frame: 1}],
       repeat: -1
    });

    game.anims.create({
       key:'up-left',
       frames: [{key: 'psu', frame: 3}],
       repeat: -1
    });

    game.anims.create({
       key:'up-right',
       frames: [{key: 'psu', frame: 2}],
       repeat: -1
    });

    game.anims.create({
       key:'down-left',
       frames: [{key: 'psu', frame: 3}],
       repeat: -1
    });

    game.anims.create({
       key:'down-right',
       frames: [{key: 'psu', frame: 2}],
       repeat: -1
    });
}

function update_player() {
    if(lock_key.isDown) {
        lock_position = true;
    } else {
        lock_position = false;
    }

    if(cursors.right.isDown) {
            if(cursors.up.isDown) {
                player.setVelocityX(player.speed);
                player.setVelocityY(-player.speed);
                if(!lock_position) {
                    player.anims.play('up-right')
                }
            } else if(cursors.down.isDown) {
                player.setVelocityX(player.speed);
                player.setVelocityY(player.speed);
                if(!lock_position) {
                    player.anims.play('down-right')
                }
            } else {
                player.setVelocityX(player.speed);
                player.setVelocityY(0);
                if(!lock_position) {
                    player.anims.play('right');
                }
            }
        } else if(cursors.left.isDown) {
            if(cursors.up.isDown) {
                player.setVelocityX(-player.speed);
                player.setVelocityY(-player.speed);
                if(!lock_position) {
                    player.anims.play('up-left')
                }
            } else if(cursors.down.isDown) {
                player.setVelocityX(-player.speed);
                player.setVelocityY(player.speed);
                if(!lock_position) {
                    player.anims.play('down-left');
                }
            } else {
                player.setVelocityX(-player.speed);
                player.setVelocityY(0);
                if(!lock_position) {
                    player.anims.play('left');
                }
            }
        } else if(cursors.up.isDown) {
            player.setVelocityY(-player.speed);
            player.setVelocityX(0);
            if(!lock_position) {
                player.anims.play('up');
            }
        } else if(cursors.down.isDown) {
            player.setVelocityY(player.speed);
            player.setVelocityX(0);
            if(!lock_position) {
                player.anims.play('down');
            }
        } else {
            player.setVelocityX(0);
            player.setVelocityY(0);
        }

    if(cursors.space.isDown) {
        if(!firing) {
            firing = true;
            var projectile = player_projectiles.create(player.x, player.y, 'low');
            var curr_dir = player.anims.currentAnim.key;
            var v = player.firingSpeed;

            switch(curr_dir) {
                case 'up':
                    projectile.setVelocityY(-v);
                break;
                case 'down':
                    projectile.setVelocityY(v);
                break;
                case 'left':
                    projectile.setVelocityX(-v);
                break;
                case 'right':
                    projectile.setVelocityX(v);
                break;
                case 'up-left':
                    projectile.setVelocityY(-v*.75);
                    projectile.setVelocityX(-v*.75);
                break;
                case 'up-right':
                    projectile.setVelocityY(-v*.75);
                    projectile.setVelocityX(v*.75);
                break;
                case 'down-left':
                    projectile.setVelocityX(-v*.75);
                    projectile.setVelocityY(v*.75);
                break;
                case 'down-right':
                    projectile.setVelocityX(v*.75);
                    projectile.setVelocityY(v*.75);
                break;
            }
        }
    } else {
        firing = false;
    }
}

</script>
</body>
</html>